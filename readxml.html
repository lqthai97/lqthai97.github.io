<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read XML</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        
        /* Style cho th·∫ª details/summary */
        details > summary {
            list-style: none;
            outline: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::before {
            content: '‚ñ∂';
            display: inline-block;
            font-size: 0.7rem;
            margin-right: 6px;
            transition: transform 0.2s;
            color: #4F46E5; /* Indigo-600 */
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        details[open] > summary {
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #312E81; /* Indigo-900 */
        }
        
        /* Hi·ªáu ·ª©ng hover */
        .node-item:hover { background-color: #F3F4F6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <div class="max-w-3xl mx-auto bg-white min-h-screen shadow-lg sm:rounded-lg sm:my-8 sm:min-h-0 overflow-hidden">
        
        <div class="bg-indigo-700 p-4 text-white sticky top-0 z-20 shadow-md">
            <h1 class="text-lg font-bold uppercase flex items-center gap-2">
                üì± Read XML
            </h1>
           
            <div class="mt-4 flex gap-2">
                <label for="xmlInput" class="flex-1 bg-white text-indigo-700 text-center font-bold py-2 px-4 rounded text-sm shadow active:bg-gray-200 cursor-pointer">
                    üìÇ M·ªü File
                </label>
                <input type="file" id="xmlInput" accept=".xml" multiple class="hidden" />
                
                <button onclick="toggleAll(true)" class="bg-indigo-600 border border-indigo-400 text-white px-3 rounded text-sm active:bg-indigo-800">
                    M·ªü h·∫øt
                </button>
                <button onclick="toggleAll(false)" class="bg-indigo-600 border border-indigo-400 text-white px-3 rounded text-sm active:bg-indigo-800">
                    ƒê√≥ng
                </button>
            </div>
        </div>

        <div id="treeContainer" class="p-2 sm:p-6 space-y-4 pb-20">
            <div id="placeholder" class="text-center text-gray-400 py-20">
                <p>Ch∆∞a c√≥ d·ªØ li·ªáu.</p>
                <p class="text-sm">Vui l√≤ng ch·ªçn file XML</p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('xmlInput').addEventListener('change', handleFiles);

        async function handleFiles(event) {
            const files = event.target.files;
            if (!files.length) return;

            const container = document.getElementById('treeContainer');
            document.getElementById('placeholder')?.remove();
            container.innerHTML = ''; // Clear c≈©

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                await readFileAndRender(file, container);
            }
            event.target.value = ''; // Reset input
        }

        function readFileAndRender(file, container) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const xmlString = e.target.result;
                        // T·∫°o khung ch·ª©a file
                        const fileWrapper = document.createElement('div');
                        fileWrapper.className = "border border-gray-300 rounded-lg overflow-hidden mb-4 bg-white shadow-sm";
                        
                        // Header file
                        fileWrapper.innerHTML = `
                            <div class="bg-gray-100 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                                <span class="font-bold text-gray-700 text-sm truncate w-2/3" title="${file.name}">üìÑ ${file.name}</span>
                                <span class="text-xs text-gray-500">${(file.size/1024).toFixed(1)} KB</span>
                            </div>
                            <div class="p-2 tree-root text-sm overflow-x-hidden"></div>
                        `;
                        
                        container.appendChild(fileWrapper);
                        const treeRoot = fileWrapper.querySelector('.tree-root');
                        
                        // Parse XML g·ªëc
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xmlString, "text/xml");
                        
                        // B·∫Øt ƒë·∫ßu v·∫Ω c√¢y t·ª´ root element
                        treeRoot.appendChild(buildTree(doc.documentElement));

                    } catch (err) {
                        alert(`L·ªói: ${err.message}`);
                    }
                    resolve();
                };
                reader.readAsText(file);
            });
        }

        // --- H√ÄM ƒê·ªÜ QUY V·∫º C√ÇY (CORE LOGIC) ---
        function buildTree(node) {
            // 1. N·∫øu l√† Text Node (Ch·ª©a gi√° tr·ªã)
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent.trim();
                if (!text) return null; // B·ªè qua kho·∫£ng tr·∫Øng
                const span = document.createElement('span');
                span.className = "text-gray-900 break-words font-medium"; 
                span.textContent = text;
                return span;
            }

            // 2. N·∫øu l√† Element Node (Th·∫ª)
            const tagName = node.tagName;
            
            // --- X·ª¨ L√ù ƒê·∫∂C BI·ªÜT: NOIDUNGFILE (BASE64) ---
            if (tagName === 'NOIDUNGFILE') {
                const base64Content = node.textContent.trim();
                // Th·ª≠ gi·∫£i m√£
                const decodedXML = decodeBase64UTF8(base64Content);
                
                if (decodedXML) {
                    // N·∫øu gi·∫£i m√£ th√†nh c√¥ng, Parse n√≥ th√†nh DOM m·ªõi
                    const parser = new DOMParser();
                    const innerDoc = parser.parseFromString(decodedXML, "text/xml");
                    
                    // T·∫°o node cha ƒë·∫°i di·ªán
                    const details = createDetailsNode("NOIDUNGFILE (ƒê√£ gi·∫£i m√£)", "text-green-700");
                    const contentDiv = details.querySelector('.tree-content');
                    
                    // ƒê·ªá quy ti·∫øp t·ª•c v·ªõi XML con v·ª´a gi·∫£i m√£
                    contentDiv.appendChild(buildTree(innerDoc.documentElement));
                    return details;
                }
            }
            // ---------------------------------------------

            // Ki·ªÉm tra xem node c√≥ con hay ch·ªâ c√≥ text
            const children = Array.from(node.childNodes).filter(n => 
                n.nodeType === Node.ELEMENT_NODE || (n.nodeType === Node.TEXT_NODE && n.textContent.trim())
            );

            // TR∆Ø·ªúNG H·ª¢P A: N√∫t L√° (Ch·ªâ c√≥ Key: Value)
            if (children.length === 1 && children[0].nodeType === Node.TEXT_NODE) {
                const div = document.createElement('div');
                div.className = "flex gap-2 py-1 border-b border-gray-50 last:border-0 node-item";
                
                const keySpan = document.createElement('span');
                keySpan.className = "text-gray-500 font-normal min-w-[100px] text-xs uppercase pt-0.5";
                keySpan.textContent = tagName;
                
                div.appendChild(keySpan);
                div.appendChild(buildTree(children[0])); // Value
                return div;
            }

            // TR∆Ø·ªúNG H·ª¢P B: N√∫t Cha (C√≥ con l·ªìng nhau) - D√πng <details>
            if (children.length > 0) {
                const details = createDetailsNode(tagName, "text-indigo-700");
                const contentDiv = details.querySelector('.tree-content');
                
                children.forEach(child => {
                    const childView = buildTree(child);
                    if (childView) contentDiv.appendChild(childView);
                });
                
                // M·∫∑c ƒë·ªãnh m·ªü n·∫øu l√† c√°c th·∫ª c·∫•p cao quan tr·ªçng
                if (['GIAMDINHHS', 'THONGTINHOSO', 'DANHSACHHOSO', 'HOSO', 'FILEHOSO', 'TONG_HOP', 'CHI_TIET_THUOC', 'CHI_TIET_DVKT'].includes(tagName)) {
                    details.open = true;
                }

                return details;
            }

            return null;
        }

        // Helper t·∫°o giao di·ªán th·∫ª ƒë√≥ng m·ªü
        function createDetailsNode(title, titleColorClass) {
            const details = document.createElement('details');
            details.className = "ml-1 mb-1 group";
            
            const summary = document.createElement('summary');
            summary.className = `text-sm select-none py-1 px-2 rounded hover:bg-gray-100 ${titleColorClass}`;
            summary.textContent = title;
            
            const content = document.createElement('div');
            content.className = "tree-content ml-3 pl-3 border-l-2 border-indigo-100 mt-1 space-y-1";
            
            details.appendChild(summary);
            details.appendChild(content);
            return details;
        }

        function decodeBase64UTF8(base64) {
            try {
                if (!base64 || base64.trim().length === 0) return null;
                const cleanBase64 = base64.replace(/\s/g, '');
                const binaryString = window.atob(cleanBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const result = new TextDecoder('utf-8').decode(bytes);
                return result.trim().startsWith('<') ? result : null;
            } catch (e) {
                return null;
            }
        }

        function toggleAll(open) {
            const allDetails = document.querySelectorAll('details');
            allDetails.forEach(el => el.open = open);
        }
    </script>
</body>
</html>
