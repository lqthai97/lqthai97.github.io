<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XML Viewer</title>
    <link rel="icon" type="image/jpeg" href="logo.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        details > summary {
            list-style: none;
            outline: none;
            cursor: pointer;
            transition: background 0.1s;
        }
        details > summary::-webkit-details-marker { display: none; }
        details > summary::before {
            content: '‚ñ∂';
            display: inline-block;
            font-size: 0.65rem;
            margin-right: 6px;
            transition: transform 0.2s;
            color: #4F46E5;
        }
        details[open] > summary::before { transform: rotate(90deg); }
        details[open] > summary {
            margin-bottom: 0.25rem;
            color: #312E81;
            font-weight: 600;
        }
        
        /* Hi·ªáu ·ª©ng hover cho d√≤ng d·ªØ li·ªáu */
        .node-row:hover { background-color: #F8FAFC; }
        
        /* Mobile optimization for long text */
        .break-anywhere {
            overflow-wrap: anywhere;
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 pb-20 sm:pb-0">

    <div class="w-full md:w-11/12 lg:max-w-6xl mx-auto bg-white min-h-screen shadow-xl sm:rounded-xl sm:my-6 sm:min-h-0 overflow-hidden flex flex-col">
        
        <div class="bg-indigo-700 p-3 sm:p-4 text-white sticky top-0 z-30 shadow-md">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                <h1 class="text-lg font-bold uppercase flex items-center gap-2 tracking-wide">
                    <img src="logo.jpg" alt="Logo" class="h-8 w-auto rounded-md shadow-sm bg-white p-0.5">
                    
                    XML Viewer <span class="text-xs font-normal bg-indigo-600 px-2 py-0.5 rounded-full hidden sm:inline-block">Lite</span>
                </h1>
                
                <div class="flex w-full sm:w-auto gap-2">
                    <label for="xmlInput" class="flex-1 sm:flex-none bg-white text-indigo-700 text-center font-bold py-2 px-4 rounded shadow active:scale-95 transition-transform cursor-pointer text-sm flex items-center justify-center gap-2">
                        <span>üìÇ</span> M·ªü File
                    </label>
                    <input type="file" id="xmlInput" accept=".xml" multiple class="hidden" />
                    
                    <button onclick="toggleAll(true)" class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-500 border border-indigo-500 text-white px-3 py-2 rounded text-sm transition-colors">
                        M·ªü h·∫øt
                    </button>
                    <button onclick="toggleAll(false)" class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-500 border border-indigo-500 text-white px-3 py-2 rounded text-sm transition-colors">
                        ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>

        <div id="treeContainer" class="p-2 sm:p-6 space-y-4 flex-grow overflow-y-auto">
            <div id="placeholder" class="text-center text-gray-400 py-24 flex flex-col items-center">
                <div class="text-6xl mb-4 opacity-20">üìÑ</div>
                <p class="font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                <p class="text-sm mt-1">Ch·ªçn file XML ƒë·ªÉ xem n·ªôi dung r√∫t g·ªçn</p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('xmlInput').addEventListener('change', handleFiles);

        // DANH S√ÅCH C√ÅC TAG C·∫¶N B·ªé QUA (Ch·ªâ l·∫•y ru·ªôt)
        const SKIP_TAGS = [
            'GIAMDINHHS', 
            'THONGTINHOSO', 
            'DANHSACHHOSO', 
            'HOSO', 
            'FILEHOSO'
        ];

        async function handleFiles(event) {
            const files = event.target.files;
            if (!files.length) return;

            const container = document.getElementById('treeContainer');
            document.getElementById('placeholder')?.remove();
            container.innerHTML = ''; 

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                await readFileAndRender(file, container);
            }
            event.target.value = ''; 
        }

        function readFileAndRender(file, container) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const xmlString = e.target.result;
                        
                        const fileWrapper = document.createElement('div');
                        fileWrapper.className = "border border-gray-200 rounded-lg overflow-hidden mb-4 bg-white shadow-sm ring-1 ring-gray-100";
                        
                        fileWrapper.innerHTML = `
                            <div class="bg-gray-50 px-3 py-2 border-b border-gray-200 flex justify-between items-center select-none sticky top-0 z-10">
                                <span class="font-bold text-gray-700 text-sm truncate w-3/4 flex items-center gap-2">
                                    <span class="text-indigo-500">üìÑ</span> ${file.name}
                                </span>
                                <span class="text-xs font-mono text-gray-500 bg-gray-200 px-2 py-0.5 rounded">${(file.size/1024).toFixed(1)} KB</span>
                            </div>
                            <div class="p-1 sm:p-2 tree-root text-sm overflow-x-auto"></div>
                        `;
                        
                        container.appendChild(fileWrapper);
                        const treeRoot = fileWrapper.querySelector('.tree-root');
                        
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xmlString, "text/xml");
                        
                        // Render
                        const content = buildTree(doc.documentElement);
                        if(content) {
                            treeRoot.appendChild(content);
                        } else {
                            treeRoot.innerHTML = '<div class="text-gray-400 italic p-2 text-xs">File r·ªóng ho·∫∑c l·ªói c·∫•u tr√∫c</div>';
                        }

                    } catch (err) {
                        alert(`L·ªói ƒë·ªçc file ${file.name}: ${err.message}`);
                    }
                    resolve();
                };
                reader.readAsText(file);
            });
        }

        // --- CORE LOGIC (Gi·ªØ nguy√™n t·ª´ phi√™n b·∫£n tr∆∞·ªõc) ---
        function buildTree(node) {
            // 1. X·ª≠ l√Ω Text Node
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent.trim();
                if (!text) return null;
                const span = document.createElement('span');
                span.className = "text-gray-800 font-medium break-anywhere block sm:inline"; 
                span.textContent = text;
                return span;
            }

            const tagName = node.tagName;

            // 2. LOGIC B·ªé QUA NODE QU·∫¢N L√ù (Flattening)
            if (SKIP_TAGS.includes(tagName)) {
                const children = Array.from(node.childNodes);
                const fragment = document.createDocumentFragment();
                let hasContent = false;

                children.forEach(child => {
                    const childView = buildTree(child);
                    if (childView) {
                        fragment.appendChild(childView);
                        hasContent = true;
                    }
                });

                return hasContent ? fragment : null;
            }

            // 3. X·ª≠ l√Ω ƒë·∫∑c bi·ªát: NOIDUNGFILE (Base64)
            if (tagName === 'NOIDUNGFILE') {
                const base64Content = node.textContent.trim();
                const decodedXML = decodeBase64UTF8(base64Content);
                
                if (decodedXML) {
                    const parser = new DOMParser();
                    const innerDoc = parser.parseFromString(decodedXML, "text/xml");
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = "mt-1 pl-1 sm:pl-2 border-l-2 border-green-400";
                    
                    const label = document.createElement('div');
                    label.className = "text-[10px] text-green-600 font-bold uppercase mb-1 tracking-wider";
                    label.textContent = "N·ªôi dung chi ti·∫øt (Decoded)";
                    wrapper.appendChild(label);

                    wrapper.appendChild(buildTree(innerDoc.documentElement));
                    return wrapper;
                }
            }

            // 4. X·ª≠ l√Ω Node th√¥ng th∆∞·ªùng
            const children = Array.from(node.childNodes).filter(n => 
                n.nodeType === Node.ELEMENT_NODE || (n.nodeType === Node.TEXT_NODE && n.textContent.trim())
            );

            // TR∆Ø·ªúNG H·ª¢P A: N√∫t L√° (Key: Value)
            if (children.length === 1 && children[0].nodeType === Node.TEXT_NODE) {
                const div = document.createElement('div');
                div.className = "flex flex-col sm:flex-row gap-0 sm:gap-2 py-1.5 border-b border-gray-100 last:border-0 node-row items-start sm:items-center";
                
                const keySpan = document.createElement('span');
                keySpan.className = "text-gray-500 font-normal min-w-[120px] text-xs uppercase tracking-tight";
                keySpan.textContent = tagName;
                
                div.appendChild(keySpan);
                div.appendChild(buildTree(children[0]));
                return div;
            }

            // TR∆Ø·ªúNG H·ª¢P B: N√∫t Cha (Container)
            if (children.length > 0) {
                const details = document.createElement('details');
                details.className = "ml-0 sm:ml-1 mb-1 group";
                details.open = true; 
                
                const summary = document.createElement('summary');
                summary.className = "text-sm py-1 px-2 rounded hover:bg-gray-100 text-indigo-700 font-semibold bg-gray-50 sm:bg-transparent";
                summary.textContent = tagName;
                
                const content = document.createElement('div');
                content.className = "ml-2 sm:ml-4 pl-2 sm:pl-3 border-l border-indigo-100 mt-1 space-y-0.5";
                
                children.forEach(child => {
                    const childView = buildTree(child);
                    if (childView) content.appendChild(childView);
                });
                
                details.appendChild(summary);
                details.appendChild(content);
                return details;
            }

            return null;
        }

        // --- HELPER FUNCTIONS ---
        function decodeBase64UTF8(base64) {
            try {
                if (!base64 || base64.trim().length === 0) return null;
                const cleanBase64 = base64.replace(/\s/g, '');
                const binaryString = window.atob(cleanBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const result = new TextDecoder('utf-8').decode(bytes);
                return result.trim().startsWith('<') ? result : null;
            } catch (e) {
                return null;
            }
        }

        function toggleAll(open) {
            document.querySelectorAll('details').forEach(el => el.open = open);
        }
    </script>
</body>
</html>
