<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chuyển đổi PDF sang Word & TXT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- docx -->
  <script src="https://unpkg.com/docx@8.0.2/dist/docx.umd.js"></script>
  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; }
    .progress-bar { transition: width 0.4s ease; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen">

  <div class="bg-white shadow-2xl rounded-2xl p-8 md:p-12 max-w-2xl w-full">
    <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-3">
      Chuyển đổi PDF sang Word & TXT
    </h1>
    <p class="text-center text-gray-500 mb-8">
      Tự động trích xuất văn bản hoặc dùng OCR cho PDF scan, bỏ qua ký tự lỗi, cho phép tải file TXT.
    </p>

    <!-- Upload -->
    <div id="uploadZone" class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-50 transition">
      <input type="file" id="pdfInput" class="hidden" accept=".pdf">
      <i class="fa-solid fa-file-pdf text-6xl text-red-500 mb-4"></i>
      <p class="text-lg font-semibold text-gray-700">Chọn hoặc kéo thả file PDF</p>
      <p class="text-sm text-gray-500 mt-2">Chỉ hỗ trợ file PDF dưới 50MB</p>
    </div>

    <!-- File info -->
    <div id="fileInfo" class="hidden mt-6 p-4 border rounded-lg flex justify-between items-center bg-gray-50">
      <div>
        <p id="fileName" class="font-semibold text-gray-700"></p>
        <p id="fileSize" class="text-gray-500 text-sm"></p>
      </div>
      <i class="fa-solid fa-file-pdf text-2xl text-red-500"></i>
    </div>

    <!-- Progress -->
    <div id="progressSection" class="hidden mt-6">
      <p id="progressText" class="text-center text-gray-700 font-medium mb-2">Đang đọc file PDF...</p>
      <div class="w-full bg-gray-200 rounded-full h-4">
        <div id="progressBar" class="bg-blue-600 h-4 rounded-full progress-bar" style="width: 0%"></div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="mt-6 space-y-3">
      <button id="convertBtn" class="hidden w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">
        <i class="fa-solid fa-sync-alt mr-2"></i>Chuyển đổi sang Word & TXT
      </button>
      <button id="downloadWordBtn" class="hidden w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">
        <i class="fa-solid fa-download mr-2"></i>Tải file Word
      </button>
      <button id="downloadTxtBtn" class="hidden w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">
        <i class="fa-solid fa-file-lines mr-2"></i>Tải file TXT
      </button>
      <button id="resetBtn" class="hidden w-full bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700 transition">
        <i class="fa-solid fa-redo mr-2"></i>Thử file khác
      </button>
    </div>

    <!-- Error -->
    <div id="errorBox" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
      <strong class="font-bold">Đã xảy ra lỗi!</strong>
      <p id="errorMsg"></p>
    </div>
  </div>

  <script>
    const pdfInput = document.getElementById("pdfInput");
    const uploadZone = document.getElementById("uploadZone");
    const fileInfo = document.getElementById("fileInfo");
    const fileNameEl = document.getElementById("fileName");
    const fileSizeEl = document.getElementById("fileSize");
    const progressSection = document.getElementById("progressSection");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const convertBtn = document.getElementById("convertBtn");
    const downloadWordBtn = document.getElementById("downloadWordBtn");
    const downloadTxtBtn = document.getElementById("downloadTxtBtn");
    const resetBtn = document.getElementById("resetBtn");
    const errorBox = document.getElementById("errorBox");
    const errorMsg = document.getElementById("errorMsg");

    let selectedFile, extractedText = "", wordBlob, txtBlob;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    uploadZone.addEventListener("click", () => pdfInput.click());
    pdfInput.addEventListener("change", e => handleFile(e.target.files[0]));

    uploadZone.addEventListener("dragover", e => { e.preventDefault(); uploadZone.classList.add("border-blue-500"); });
    uploadZone.addEventListener("dragleave", e => uploadZone.classList.remove("border-blue-500"));
    uploadZone.addEventListener("drop", e => {
      e.preventDefault();
      uploadZone.classList.remove("border-blue-500");
      handleFile(e.dataTransfer.files[0]);
    });

    resetBtn.onclick = () => location.reload();

    async function handleFile(file) {
      if (!file || file.type !== "application/pdf") return showError("Vui lòng chọn file PDF hợp lệ.");
      selectedFile = file;
      fileNameEl.textContent = file.name;
      fileSizeEl.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
      uploadZone.classList.add("hidden");
      fileInfo.classList.remove("hidden");
      convertBtn.classList.remove("hidden");
      hideError();
    }

    convertBtn.onclick = async () => {
      convertBtn.classList.add("hidden");
      progressSection.classList.remove("hidden");
      progressText.textContent = "Đang đọc file PDF...";
      progressBar.style.width = "10%";

      try {
        extractedText = await extractTextFromPDF(selectedFile);
      } catch {
        progressText.textContent = "Đang dùng OCR (ảnh scan)...";
        extractedText = await extractTextUsingOCR(selectedFile);
      }

      if (!extractedText.trim()) {
        showError("Không thể trích xuất nội dung. Một số ký tự có thể bị bỏ qua.");
        resetBtn.classList.remove("hidden");
        return;
      }

      progressBar.style.width = "90%";
      progressText.textContent = "Đang tạo file Word & TXT...";

      try {
        const { Document, Packer, Paragraph, TextRun } = docx;
        const paragraphs = extractedText.split("\n").map(p => new Paragraph({ children: [new TextRun(p)] }));
        const doc = new Document({ sections: [{ children: paragraphs }] });
        wordBlob = await Packer.toBlob(doc);
        txtBlob = new Blob([extractedText], { type: "text/plain;charset=utf-8" });
      } catch {
        showError("Không thể tạo file Word. Một số ký tự đã bị bỏ qua.");
      }

      progressBar.style.width = "100%";
      progressText.textContent = "Hoàn tất!";
      downloadWordBtn.classList.remove("hidden");
      downloadTxtBtn.classList.remove("hidden");
      resetBtn.classList.remove("hidden");
    };

    async function extractTextFromPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = "";
      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(it => it.str).join(" ") + "\n";
        progressBar.style.width = `${(i / pdfDoc.numPages) * 80}%`;
      }
      return text.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, "");
    }

    async function extractTextUsingOCR(file) {
      const data = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data }).promise;
      let ocrText = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: context, viewport }).promise;
        const { data: { text } } = await Tesseract.recognize(canvas, "vie", { logger: m => console.log(m) });
        ocrText += text + "\n";
        progressBar.style.width = `${(i / pdf.numPages) * 80}%`;
      }
      return ocrText;
    }

    downloadWordBtn.onclick = () => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(wordBlob);
      a.download = selectedFile.name.replace(/\.pdf$/i, ".docx");
      a.click();
    };
    downloadTxtBtn.onclick = () => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(txtBlob);
      a.download = selectedFile.name.replace(/\.pdf$/i, ".txt");
      a.click();
    };

    function showError(msg) {
      errorBox.classList.remove("hidden");
      errorMsg.textContent = msg;
    }
    function hideError() {
      errorBox.classList.add("hidden");
    }
  </script>
</body>
</html>
